<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="chromedash-color-status.html">

<!-- https://github.com/ljosa/urlize.js -->
<script src="urlize.js"></script>

<dom-module id="html-echo">
</dom-module>
<script>
  Polymer({
    is: 'html-echo',
    properties: {
      html: {
        observer: 'htmlChanged'
      }
    },
    htmlChanged: function() {
      this.innerHTML = this.html;
    }
  });
</script>

<dom-module id="multi-links">
  <link rel="import" type="css" href="../css/shared.css">
  <template>
    <template is="dom-repeat" items="{{links}}" as="link" index-as="i">
      <a href$="{{link}}" target="_blank">{{_computeLink(link)}}</a><template is="dom-if" if="{{_computeShowComma(i, links)}}">,</template>
    </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'multi-links',
    properties: {
      links: {
        type: Array,
        value: function() { return []; }
      }
    },
    _prettyURLFilter: function(val) {
      return val.replace(/https?:\/\//, '');
    },
    _computeShowComma: function(i, links) {
      return links.length > 1 && i < links.length - 1;
    },
    _computeLink: function(link) {
      return this._prettyURLFilter(link);
    }
  });
</script>

<dom-module id="chromedash-feature">
<link rel="import" type="css" href="../css/elements/chromedash-feature.css">
<template>
<div on-tap="toggle" class="main-content-area">
  <hgroup>
    <chromedash-color-status class="tooltip corner" title="Compatibility risk: perceived interest from browser vendors and web developers" value="{{compatRisk}}" max="{{MAX_RISK}}"></chromedash-color-status>
    <h2>{{feature.name}}</h2>
    <div class="iconrow">
      <label class="category" on-tap="categoryFilter">{{feature.category}}</label>
      <div class="topcorner">
        <span hidden$="{{!removed}}" class="tooltip" title="Removed feature">
          <iron-icon icon="icons:cancel" class="remove" data-tooltip></iron-icon>
        </span>
        <span hidden$="{{!deprecated}}" class="tooltip" title="Deprecated feature">
          <iron-icon icon="icons:warning" class="deprecated" data-tooltip></iron-icon>
        </span>
        <span hidden$="{{!needsflag}}" class="tooltip" title="Experimental feature behind a flag">
          <iron-icon icon="icons:extension" class="experimental"></iron-icon>
        </span>
        <span class="tooltip" title="Edit this feature" hidden$="{{!whitelisted}}">
          <a href$="{{_computeEditLinkHidden(feature)}}" class="editfeature" data-tooltip>
            <iron-icon icon="icons:create"></iron-icon>
          </a>
        </span>
      </div>
    </div>
  </hgroup>
  <section class="desc"><summary class$="{{_computeSummaryClass(open)}}">{{feature.summary}}</summary></section>
  <template is="dom-if" if="{{open}}">
    <section>
      <h3>Implementation Status</h3>
      <div class="impl_status">
        <template is="dom-if" if="{{feature.shipped_milestone}}">
          <span class="chrome_desktop tooltip" title="Chrome desktop"><label>{{feature.impl_status_chrome}}</label>{{feature.shipped_milestone}}</span>
        </template>
        <template is="dom-if" if="{{!feature.shipped_milestone}}">
          <span class="chrome_desktop"><label>{{feature.impl_status_chrome}}</label></span>
        </template>
        <template is="dom-if" if="{{feature.shipped_android_milestone}}">
          <span class="chrome_android tooltip" title="Chrome for Android">
            <iron-icon icon="icons:android" class="android"></iron-icon>
            <span>{{feature.shipped_android_milestone}}</span>
          </span>
        </template>
        <template is="dom-if" if="{{feature.shipped_webview_milestone}}">
          <span class="chrome_webview tooltip" title="Chrome Webview"><label>Webview</label>{{feature.shipped_webview_milestone}}</span>
        </template>
        <span hidden$="{{!feature.prefixed}}"><label>Prefixed</label>Yes</span>
        <span hidden$="{{!feature.bug_url}}"><a href$="{{feature.bug_url}}" target="_blank">Launch bug</a></span>
        <span class="owner" hidden$="{{!feature.owner.length}}">
          <label>Owner(s)</label><template is="dom-repeat" items="{{feature.owner}}" as="owner" index-as="i">
            <span on-tap="ownerFilter">{{owner}}</span>
            <template is="dom-if" if="{{_computeShowComma(feature, i)}}">,</template>
          </template>
        </span>
      </div>
    </section>
    <section>
      <h3>Consensus &amp; Standardization</h3>
      <div class="views">
        <template is="dom-if" if="{{feature.shipped_opera_milestone}}">
          <span title="{{feature.impl_status_chrome}}">
            Opera <span>{{feature.shipped_opera_milestone}}</span>
          </span>
        </template>
        <template is="dom-if" if="{{feature.shipped_opera_android_milestone}}">
          <span title="{{feature.impl_status_chrome}}">
            Opera for Android <span>{{feature.shipped_opera_android_milestone}}</span>
          </span>
        </template>
        <span title="{{feature.ff_views.text}}">
          <chromedash-color-status value="{{feature.ff_views.value}}" max="{{MAX_VENDOR_VIEW}}"></chromedash-color-status>
          <template is="dom-if" if="{{feature.ff_views_link}}">
            <a href$="{{feature.ff_views_link}}" target="_blank">Firefox</a>
          </template>
          <label hidden$="{{feature.ff_views_link}}">Firefox</label>
        </span>
        <span title="{{feature.ie_views.text}}">
          <chromedash-color-status value="{{feature.ie_views.value}}" max="{{MAX_VENDOR_VIEW}}"></chromedash-color-status>
          <template is="dom-if" if="{{feature.ie_views_link}}">
            <a href$="{{feature.ie_views_link}}" target="_blank">Edge</a>
          </template>
          <label hidden$="{{feature.ie_views_link}}">Edge</label>
        </span>
        <span title="{{feature.safari_views.text}}">
          <chromedash-color-status value="{{feature.safari_views.value}}" max="{{MAX_VENDOR_VIEW}}"></chromedash-color-status>
          <template is="dom-if" if="{{feature.safari_views_link}}">
            <a href$="{{feature.safari_views_link}}" target="_blank">Safari</a>
          </template>
          <label hidden$="{{feature.safari_views_link}}">Safari</label>
        </span>
        <span title="{{feature.web_dev_views.text}}">
          <chromedash-color-status value="{{feature.web_dev_views.value}}" max="{{MAX_WEBDEV_VIEW}}"></chromedash-color-status>
          <label>Web developers</label>
        </span>
      </div>
      <div class="standardization">
        <span>
          <chromedash-color-status value="{{feature.standardization.value}}" max="{{MAX_STANDARDS_VAL}}"></chromedash-color-status>
          <template is="dom-if" if="{{feature.spec_link}}">
            <a href$="{{feature.spec_link}}" target="_blank">{{feature.standardization.text}}</a>
          </template>
          <span hidden$="{{feature.spec_link}}">{{feature.standardization.text}}</span>
        </span>
      </div>
    </section>
    <template is="dom-if" if="{{_computeShowResources(feature)}}">
      <section>
        <h3>Developer resources</h3>
        <div>
          <template is="dom-if" if="{{_computeShowDocLinks(feature)}}">
            <span class="doc_links" hidden$="{{!feature.doc_links.length}}">
              <label>Documentation</label>
              <multi-links links="[[feature.doc_links]]"></multi-links>
            </span>
          </template>
        </div>
        <div>
          <template is="dom-if" if="{{_computeShowDocLinks(feature)}}">
            <span class="sample_links" hidden$="{{!feature.sample_links.length}}">
              <label>Samples</label>
              <multi-links links="[[feature.sample_links]]"></multi-links>
            </span>
          </template>
        </div>
      </section>
    </template>
    <template is="dom-if" if="{{feature.comments}}">
      <section>
        <h3>Comments</h3>
        <summary class="comments"><html-echo html="[[_computeHtml(feature)]]"></html-echo></summary>
      </section>
    </template>
  </template>
</div>
<a href$="{{_computeStandaloneHref(feature)}}" target="_blank"
   class="open-standalone" title="View on standalone page">
  <iron-icon icon="icons:open-in-new" class="opennew" data-tooltip></iron-icon>
</a>
</template>
</dom-module>
<script>
  Polymer({
    is: 'chromedash-feature',
    extends: 'li',

    hostAttributes: {
      tabindex: '0'
    },

    properties: {
      MAX_RISK: {
        type: Number,
        computed: '_computeMaxRisk(MAX_VENDOR_VIEW, MAX_WEBDEV_VIEW, MAX_STANDARDS_VAL)'
      },
      MAX_STANDARDS_VAL: {
        type: Number,
        value: 6,
        readOnly: true
      },
      MAX_VENDOR_VIEW: {
        type: Number,
        value: 7,
        readOnly: true
      },
      MAX_WEBDEV_VIEW: {
        type: Number,
        value: 6,
        readOnly: true
      },
      compatRisk: {
        type: Number,
        value: 0
      },
      deprecated: {
        type: Boolean,
        // value: false,
        computed: '_computeDeprecated(feature.impl_status_chrome)'
      },
      removed: {
        type: Boolean,
        computed: '_computeRemoved(feature.impl_status_chrome)'
      },
      feature: {
        value: null,
        observer: '_featureChanged'
      },
      needsflag: {
        type: Boolean,
        value: false
      },
      open: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '_openChanged'
      }
    },

    toggle: function(e, details) {
      // Don't toggle panel if tooltip or link is being clicked.
      var target = Polymer.dom(e).localTarget;
      if (target.classList.contains('tooltip') || 'tooltip' in target.dataset ||
          target.tagName == 'A' || target.tagName == 'MULTI-LINKS') {
        return;
      }
      this.open = !this.open;
    },

    categoryFilter: function(e, details) {
      e.stopPropagation();
      this.fire('filter-category', {val: Polymer.dom(e).localTarget.textContent});
    },

    ownerFilter: function(e, details) {
      e.stopPropagation();
      this.fire('filter-owner', {val: Polymer.dom(e).localTarget.textContent});
    },

    _urlizeFilter: function(val) {
      return urlize(val, {target: '_blank', trim: 'www', autoescape: true});
    },

    _calculateCompatRisk: function() {
      var vendors = (this.feature.ff_views.value + this.feature.ie_views.value + this.feature.safari_views.value) / 3;
      var webdevs = this.feature.web_dev_views.value;
      var standards = this.feature.standardization.value;
      this.compatRisk = vendors + webdevs + standards;
    },

    _openChanged: function() {
      this.open ? this.classList.add('open') : this.classList.remove('open');
      this.fire('feature-toggled', {
        feature: this.feature,
        open: this.open
      });
    },

    _featureChanged: function() {
      this._calculateCompatRisk();  // TODO: these values are brittle if the strings change.
    },

    _computeTitle: function(removed) {
      return removed ? 'Removed feature' : 'Deprecated feature';
    },
    _computeStandaloneHref: function(feature) {
      return '/feature/' + feature.id;
    },
    _computeSummaryClass: function(open) {
      return open ? 'open' : '';
    },
    _computeShowResources: function(feature) {
      return feature.doc_links.length || feature.sample_links.length;
    },
    _computeShowComma: function(feature, i) {
      return feature.owner.length > 1 && i < feature.owner.length - 1;
    },
    _computeShowDocLinks: function(feature) {
      return feature.doc_links && feature.doc_links.length > 0;
    },
    _computeSampleLinks: function(feature) {
      return feature.sample_links && feature.sample_links.length > 0;
    },
    _computeHtml: function(feature) {
      return this._urlizeFilter(feature.comments);
    },
     _computeMaxRisk: function(vendorViewVal, webdevViewVal, standardsVal) {
      return vendorViewVal + webdevViewVal + standardsVal;
    },
    _computeRemoved: function(implStatusChrome) {
      return implStatusChrome == 'Removed';
    },
    _computeDeprecated: function(implStatusChrome) {
      return implStatusChrome === 'Deprecated' ||
             implStatusChrome === 'No longer pursuing';
    },
    _computeEditLinkHidden: function(feature) {
      return '/admin/features/edit/' + feature.id;
    },
  });
</script>
